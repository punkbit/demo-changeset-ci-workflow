#!/bin/bash
#
# Verify that a commit message matches the expected release format
# Usage: verify-release-commit <commit_message>
# Returns: 0 if valid, 1 if invalid
# On success: outputs "VERSION RELEASE_TYPE" (e.g., "1.2.3 latest")
# On failure: outputs error messages to stderr only

if [[ $# -lt 1 ]]; then
  echo "ðŸ‘¹ Oops! Missing argument..."
  exit 1
fi

COMMIT_MSG="$1"

RELEASE_PATTERN='^chore: ðŸ¤– release v([0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?) \((latest|rc|test)\)$'

if [[ -z "$COMMIT_MSG" ]]; then
  echo "ðŸ‘¹ Oops! Commit message is empty"
  exit 1
fi

if [[ ! "$COMMIT_MSG" =~ ^chore: ]]; then
  echo "ðŸ¦– Skip! Commit message does not start with 'chore:'"
  exit 1
fi

if [[ ! "$COMMIT_MSG" =~ ðŸ¤– ]]; then
  echo "ðŸ¦– Skip! Commit message is missing the ðŸ¤– emoji"
  exit 1
fi

if [[ ! "$COMMIT_MSG" =~ release ]]; then
  echo "ðŸ¦– Skip! Commit message does not contain 'release'"
  exit 1
fi

if [[ ! "$COMMIT_MSG" =~ v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
  echo "ðŸ¦– Skip! Commit message does not contain a valid version number"
  exit 1
fi

if [[ ! "$COMMIT_MSG" =~ \((latest|rc|test)\)$ ]]; then
  echo "ðŸ¦– Skip! Commit message does not end with a valid release type"
  exit 1
fi

if [[ ! "$COMMIT_MSG" =~ $RELEASE_PATTERN ]]; then
  echo "ðŸ¦– Skip! Commit message format is invalid"
  exit 1
fi

VERSION=$(echo "$COMMIT_MSG" | sed -n 's/^chore: ðŸ¤– release v\([0-9.a-zA-Z-]*\) (\(.*\))$/\1/p')
RELEASE_TYPE=$(echo "$COMMIT_MSG" | sed -n 's/^chore: ðŸ¤– release v\([0-9.a-zA-Z-]*\) (\(.*\))$/\2/p')

echo "${VERSION} ${RELEASE_TYPE}"

exit 0
